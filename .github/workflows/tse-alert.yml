name: TSE Review Alert

on:
  issues:
    types: [labeled]

jobs:
  notify_slack:
    # Only run if the specific label was added
    if: github.event.label.name == 'tse_review'
    runs-on: ubuntu-latest
    steps:
      - name: Create Slack Payload
        id: slack_payload
        env:
          # 1. UPDATE YOUR GROUP ID HERE
          GROUP_ID: "S0A12AJGEMU" 
          # Pulling data from GitHub event
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          USER_LOGIN: ${{ github.event.issue.user.login }}
        run: |
          # We use jq to build the JSON object. 
          # This is much safer than string concatenation because it handles 
          # escaping quotes/special characters in the title automatically.
          jq -n \
            --arg group "$GROUP_ID" \
            --arg title "$ISSUE_TITLE" \
            --arg url "$ISSUE_URL" \
            --arg user "$USER_LOGIN" \
            '{
              text: "<!subteam^\($group)> Review Requested: \($title)",
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ":rotating_light: *TSE Review Requested* <!subteam^\($group)>"
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "*<\($url)|\($title)>*\nRequested by: \($user)"
                  }
                }
              ]
            }' > payload.json

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          # Read the safe JSON file we just created
          payload-file-path: "./payload.json"
